<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP è¿ç»´ç›‘æ§ç³»ç»Ÿ</title>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --text: #c9d1d9; --blue: #58a6ff; --green: #238636; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; padding: 40px; margin: 0; }
        .card { background: var(--card); border: 1px solid #30363d; border-radius: 12px; padding: 24px; width: 100%; max-width: 450px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .status-header { display: flex; align-items: center; gap: 10px; margin-bottom: 25px; border-bottom: 1px solid #30363d; padding-bottom: 15px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; background: #484f58; transition: 0.3s; }
        .online { background: #3fb950; box-shadow: 0 0 12px #3fb950; }
        .stat-item { margin-bottom: 25px; }
        .label-group { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 8px; font-weight: 500; }
        .bar-bg { background: #30363d; height: 10px; border-radius: 5px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; background: var(--blue); transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
        button { background: var(--green); color: white; border: 1px solid rgba(240,246,252,0.1); padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 15px; font-weight: 600; transition: 0.2s; }
        button:hover:not(:disabled) { background: #2ea043; }
        button:disabled { background: #21262d; color: #8b949e; cursor: not-allowed; border-color: transparent; }
        #log { margin-top: 20px; font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace; font-size: 11px; color: #8b949e; background: #010409; padding: 12px; border-radius: 6px; max-height: 150px; overflow-y: auto; border: 1px solid #30363d; }
        .log-entry { margin-bottom: 4px; border-left: 2px solid #30363d; padding-left: 8px; }
    </style>
</head>
<body>

<div class="card">
    <div class="status-header">
        <div id="dot" class="dot"></div>
        <h2 style="margin:0; font-size: 18px;">Aliyun 2C2G å®æ—¶ç›‘æ§</h2>
    </div>

    <div class="stat-item">
        <div class="label-group"><span>CPU ä½¿ç”¨ç‡</span><span id="cpu-txt">0%</span></div>
        <div class="bar-bg"><div id="cpu-bar" class="bar-fill"></div></div>
    </div>

    <div class="stat-item">
        <div class="label-group"><span>å†…å­˜å ç”¨</span><span id="mem-txt">0%</span></div>
        <div class="bar-bg"><div id="mem-bar" class="bar-fill"></div></div>
    </div>

    <button id="refreshBtn" onclick="sendToolCall()" disabled>åˆå§‹åŒ–ä¸­...</button>
    <div id="log"></div>
</div>



<script>
    let messageUrl = "";
    const logEl = document.getElementById('log');
    const refreshBtn = document.getElementById('refreshBtn');

    // 1. å»ºç«‹ SSE è¿æ¥
    const eventSource = new EventSource('/sse');

    eventSource.onopen = () => {
        addLog("ğŸŒ SSE éš§é“å·²è¿æ¥");
        document.getElementById('dot').classList.add('online');
    };

    // 2. åè®®æ ¸å¿ƒï¼šç›‘å¬ Endpoint å¹¶å®Œæˆæ¡æ‰‹
    eventSource.addEventListener("endpoint", async (e) => {
        messageUrl = e.data;
        addLog("ğŸ”— æ¶ˆæ¯è·¯ç”±å·²æ¿€æ´»");
        
        // ç¬¬ä¸€æ­¥ï¼šå‘é€ initialize
        addLog("ğŸš€ æ­£åœ¨æ¡æ‰‹ (initialize)...");
        const initResult = await postToMcp({
            jsonrpc: "2.0",
            id: "init_v1",
            method: "initialize",
            params: {
                protocolVersion: "2024-11-05",
                capabilities: {},
                clientInfo: { name: "web-dashboard", version: "1.0.0" }
            }
        });

        if (initResult) {
            // ç¬¬äºŒæ­¥ï¼šå‘é€ notifications/initialized
            await postToMcp({
                jsonrpc: "2.0",
                method: "notifications/initialized"
            });
            
            addLog("âœ… æ¡æ‰‹æˆåŠŸï¼ŒæœåŠ¡å°±ç»ª");
            refreshBtn.disabled = false;
            refreshBtn.innerText = "ç«‹å³åˆ·æ–°æ•°æ®";
            sendToolCall(); // åˆå§‹åŠ è½½æ•°æ®
        }
    });

    // 3. å¤„ç†ä» SSE æ¨å›çš„ç»“æœ
    eventSource.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            
            // å“åº” initialize ä¼šåŒ…å«æœåŠ¡ç«¯èƒ½åŠ›ï¼Œæˆ‘ä»¬ä¸»è¦çœ‹å·¥å…·ç»“æœ
            if (data.result && data.result.content) {
                const stats = JSON.parse(data.result.content[0].text);
                updateUI(stats);
                addLog("ğŸ“¥ æ•°æ®å·²æ›´æ–°");
            }
        } catch (err) {
            console.debug("å¿½ç•¥éç»“æ„åŒ–æ¶ˆæ¯");
        }
    };

    // 4. é€šç”¨çš„ POST å‘é€å‡½æ•°
    async function postToMcp(payload) {
        try {
            const response = await fetch(messageUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            return await response.text(); // MCP è¿”å› "Accepted" æ–‡æœ¬
        } catch (err) {
            addLog("âŒ é€šè®¯å¤±è´¥: " + err.message);
            return null;
        }
    }

    // 5. æ‰§è¡Œå·¥å…·è°ƒç”¨
    function sendToolCall() {
        if (!messageUrl) return;
        addLog("ğŸ“¤ è¯·æ±‚å®æ—¶æ•°æ®...");
        postToMcp({
            jsonrpc: "2.0",
            id: Date.now(),
            method: "tools/call",
            params: { name: "get_system_status", arguments: {} }
        });
    }

    function updateUI(stats) {
        document.getElementById('cpu-txt').innerText = stats.cpu_usage;
        document.getElementById('cpu-bar').style.width = stats.cpu_usage;
        document.getElementById('mem-txt').innerText = stats.memory_usage;
        document.getElementById('mem-bar').style.width = stats.memory_usage;
        
        // åŠ¨æ€é¢œè‰²ï¼šè¶…è¿‡ 80% å˜çº¢
        const cpuVal = parseFloat(stats.cpu_usage);
        document.getElementById('cpu-bar').style.background = cpuVal > 80 ? '#da3633' : '#58a6ff';
    }

    function addLog(msg) {
        const time = new Date().toLocaleTimeString().split(' ')[0];
        logEl.innerHTML += `<div class="log-entry"><strong>${time}</strong> ${msg}</div>`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    eventSource.onerror = () => {
        addLog("ğŸš¨ SSE è¿æ¥æ–­å¼€ï¼Œè¯·æ£€æŸ¥åç«¯");
        document.getElementById('dot').classList.remove('online');
        refreshBtn.disabled = true;
    };
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP å¼‚æ­¥è¿ç»´çœ‹æ¿</title>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --text: #c9d1d9; --blue: #58a6ff; }
        body { font-family: system-ui; background: var(--bg); color: var(--text); display: flex; justify-content: center; padding: 40px; }
        .card { background: var(--card); border: 1px solid #30363d; border-radius: 12px; padding: 24px; width: 100%; max-width: 450px; }
        .stat-item { margin-bottom: 20px; }
        .bar-bg { background: #30363d; height: 8px; border-radius: 4px; margin-top: 8px; }
        .bar-fill { height: 100%; width: 0%; background: var(--blue); border-radius: 4px; transition: width 0.8s ease; }
        button { background: #238636; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; }
        button:disabled { background: #21262d; color: #8b949e; cursor: not-allowed; }
        #log { margin-top: 20px; font-size: 12px; color: #8b949e; background: #010409; padding: 10px; border-radius: 6px; max-height: 120px; overflow-y: auto; line-height: 1.6; }
        .status-header { display: flex; align-items: center; gap: 8px; margin-bottom: 20px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: gray; }
        .online { background: #3fb950; box-shadow: 0 0 8px #3fb950; }
    </style>
</head>
<body>

<div class="card">
    <div class="status-header">
        <div id="dot" class="dot"></div>
        <h2 style="margin:0">æœåŠ¡å™¨å®æ—¶ç›‘æ§</h2>
    </div>

    <div class="stat-item">
        <div style="display:flex; justify-content:space-between"><span>CPU ä½¿ç”¨ç‡</span><span id="cpu-txt">0%</span></div>
        <div class="bar-bg"><div id="cpu-bar" class="bar-fill"></div></div>
    </div>

    <div class="stat-item">
        <div style="display:flex; justify-content:space-between"><span>å†…å­˜å ç”¨</span><span id="mem-txt">0%</span></div>
        <div class="bar-bg"><div id="mem-bar" class="bar-fill"></div></div>
    </div>

    <button id="refreshBtn" onclick="sendRefreshRequest()" disabled>ç­‰å¾…é€šé“å°±ç»ª...</button>
    <div id="log">æ­£åœ¨åˆå§‹åŒ– SSE è¿æ¥...</div>
</div>



<script>
    let messageUrl = "";
    const logEl = document.getElementById('log');
    const refreshBtn = document.getElementById('refreshBtn');

    // 1. åˆå§‹åŒ– SSE è¿æ¥ (é€šè¿‡ Nginx è½¬å‘è·¯å¾„ /sse)
    const eventSource = new EventSource('/sse');

    // ç›‘å¬é€šé“å¼€å¯
    eventSource.onopen = () => {
        addLog("âœ… SSE éš§é“å·²è¿æ¥");
        document.getElementById('dot').classList.add('online');
    };

    // å…³é”®ï¼šè·å–æ¶ˆæ¯å‘é€çš„ Endpoint
    eventSource.addEventListener("endpoint", (e) => {
        messageUrl = e.data; 
        addLog("ğŸ”— æ¶ˆæ¯è·¯ç”±å·²æ¿€æ´»");
        refreshBtn.disabled = false;
        refreshBtn.innerText = "ç«‹å³åˆ·æ–°æ•°æ®";
        sendRefreshRequest(); // è‡ªåŠ¨åˆæ¬¡åŠ è½½
    });

    // æ ¸å¿ƒé€»è¾‘ï¼šå¤„ç†ä» SSE é€šé“å›ä¼ çš„æ•°æ®
    eventSource.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            
            // åŒ¹é… JSON-RPC å“åº”åŒ…
            if (data.result && data.result.content) {
                const stats = JSON.parse(data.result.content[0].text);
                updateUI(stats);
                addLog("ğŸ“¥ æ”¶åˆ°æœ€æ–°æ•°æ®åŒ…");
            }
        } catch (err) {
            // å¿½ç•¥é JSON çš„å¿ƒè·³æˆ– Accepted æ–‡æœ¬
            console.debug("å¿½ç•¥éç»“æ„åŒ–æ¶ˆæ¯", event.data);
        }
    };

    // 2. å‘é€æŒ‡ä»¤ (é€šè¿‡ POST åˆ° messageUrl)
    async function sendRefreshRequest() {
        if (!messageUrl) return;
        
        addLog("ğŸ“¤ å‘é€åˆ·æ–°è¯·æ±‚...");
        try {
            const response = await fetch(messageUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    jsonrpc: "2.0",
                    id: Date.now(),
                    method: "tools/call",
                    params: { name: "get_system_status", arguments: {} }
                })
            });

            // ä¿®å¤ Accepted æŠ¥é”™çš„æ ¸å¿ƒï¼šä¸ä½¿ç”¨ response.json()
            const text = await response.text(); 
            if (text.includes("Accepted")) {
                addLog("ğŸ†— æœåŠ¡å™¨å·²å—ç†è¯·æ±‚");
            }
        } catch (err) {
            addLog("âŒ è¯·æ±‚å¤±è´¥: " + err.message);
        }
    }

    function updateUI(stats) {
        document.getElementById('cpu-txt').innerText = stats.cpu_usage;
        document.getElementById('cpu-bar').style.width = stats.cpu_usage;
        document.getElementById('mem-txt').innerText = stats.memory_usage;
        document.getElementById('mem-bar').style.width = stats.memory_usage;
    }

    function addLog(msg) {
        const time = new Date().toLocaleTimeString().split(' ')[0];
        logEl.innerHTML += `<div>[${time}] ${msg}</div>`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    eventSource.onerror = () => {
        addLog("ğŸš¨ è¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ Nginx æˆ– MCP è¿›ç¨‹");
        document.getElementById('dot').classList.remove('online');
    };
</script>

</body>
</html>
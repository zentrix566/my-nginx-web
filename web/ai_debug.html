<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MCP + DeepSeek æ™ºèƒ½è¿ç»´</title>
    <style>
        body { font-family: system-ui; background: #0d1117; color: #c9d1d9; padding: 20px; display: flex; gap: 20px; }
        .panel { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 15px; flex: 1; display: flex; flex-direction: column; }
        #log { background: #000; color: #79c0ff; height: 300px; overflow-y: auto; font-size: 12px; padding: 10px; border-radius: 4px; flex-grow: 1; }
        #chat-history { height: 400px; overflow-y: auto; border-bottom: 1px solid #333; margin-bottom: 10px; }
        .msg { margin: 8px 0; padding: 10px; border-radius: 6px; line-height: 1.4; max-width: 90%; }
        .user { background: #1f6feb; align-self: flex-end; margin-left: auto; }
        .ai { background: #238636; align-self: flex-start; }
        .input-group { display: flex; gap: 10px; }
        input { flex-grow: 1; padding: 8px; background: #010409; color: white; border: 1px solid #30363d; border-radius: 4px; }
        button { padding: 8px 15px; cursor: pointer; background: #238636; color: white; border: none; border-radius: 4px; font-weight: bold; }
        button:disabled { background: #21262d; color: #8b949e; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="panel">
    <h3>æ™ºèƒ½å¯¹è¯ (DeepSeek)</h3>
    <div id="chat-history"></div>
    <div class="input-group">
        <input type="text" id="userInput" placeholder="é—®é—®æœåŠ¡å™¨ç°åœ¨å¡å—...">
        <button id="askBtn" onclick="askAI()">æé—®</button>
    </div>
</div>

<div class="panel">
    <h3>MCP æ§åˆ¶å°</h3>
    <button onclick="initMCP()">1. è¿æ¥ MCP æœåŠ¡</button>
    <div id="status" style="margin: 10px 0; font-weight: bold;">çŠ¶æ€: æœªè¿æ¥</div>
    <div id="log"></div>
</div>

<script>
    // æ³¨å…¥ç‚¹
    // const DEEPSEEK_KEY = "${DEEPSEEK_KEY}";
<<<<<<< Updated upstream
    const DEEPSEEK_KEY = "aaaa";
=======
    // const DEEPSEEK_KEY = "__DS_KEY_PLACEHOLDER__";
    const DEEPSEEK_KEY = "aaaaa";     // é˜²æ­¢æ³„å¯†
>>>>>>> Stashed changes
    let messageUrl = "";
    let mcpData = "æš‚æ— æ•°æ®"; 

    const logEl = document.getElementById('log');

    function addLog(msg, type = 'info') {
        const colors = { info: '#79c0ff', ai: '#aff5b4', tool: '#d2a8ff', error: '#ff7b72' };
        const div = document.createElement('div');
        div.style.color = colors[type] || colors.info;
        div.style.marginBottom = '4px';
        div.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
        logEl.appendChild(div);
        logEl.scrollTop = logEl.scrollHeight;
    }

    async function initMCP() {
        addLog("æ­£åœ¨å¯åŠ¨ SSE è¿æ¥...");
        const es = new EventSource('/sse');
        es.addEventListener("endpoint", async (e) => {
            messageUrl = e.data;
            addLog("ğŸ”— æ¶ˆæ¯éš§é“å·²å»ºç«‹", 'info');
            
            await fetch(messageUrl, {
                method: "POST",
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    jsonrpc: "2.0", id: "i1", method: "initialize",
                    params: { protocolVersion: "2024-11-05", capabilities: {tools:{}}, clientInfo: {name: "web-client", version: "1.0"}}
                })
            });
            await fetch(messageUrl, { 
                method: "POST", 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ jsonrpc: "2.0", method: "notifications/initialized" }) 
            });
            
            document.getElementById('status').innerText = "çŠ¶æ€: å·²å°±ç»ª (MCP Online)";
            document.getElementById('status').style.color = "#3fb950";
            addLog("âœ… MCP åˆå§‹åŒ–æ¡æ‰‹æˆåŠŸ", 'info');
        });

        es.onmessage = (e) => {
            try {
                const res = JSON.parse(e.data);
                if (res.result && res.result.content) {
                    mcpData = res.result.content[0].text;
                    addLog("ğŸ“¥ æ”¶åˆ°å·¥å…·æ‰§è¡Œç»“æœ: " + mcpData, 'tool');
                }
            } catch(err) {}
        };
    }

    async function askAI() {
        const text = document.getElementById('userInput').value;
        if (!text) return;
        if (!messageUrl) { alert("è¯·å…ˆè¿æ¥ MCP æœåŠ¡ï¼"); return; }

        appendChat('user', text);
        document.getElementById('userInput').value = "";
        addLog("ğŸš€ æ­£åœ¨å’¨è¯¢ DeepSeek...", 'ai');

        try {
            const response = await fetch("https://api.deepseek.com/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${DEEPSEEK_KEY}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [{ role: "user", content: text }],
                    tools: [{
                        type: "function",
                        function: {
                            name: "get_system_status",
                            description: "è·å–æœåŠ¡å™¨ CPU å’Œå†…å­˜å ç”¨"
                        }
                    }]
                })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            
            const msg = data.choices[0].message;

            if (msg.tool_calls) {
                const toolCall = msg.tool_calls[0];
                addLog(`ğŸ¤– AI å†³å®šè°ƒç”¨å·¥å…·: ${toolCall.function.name}`, 'ai');
                
                await fetch(messageUrl, {
                    method: "POST",
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        jsonrpc: "2.0", id: "call_" + Date.now(),
                        method: "tools/call",
                        params: { name: "get_system_status", arguments: {} }
                    })
                });

                // ç­‰å¾… SSE æ¥æ”¶å¹¶æ›´æ–° mcpData
                setTimeout(async () => {
                    addLog("ğŸ”„ å°†æ•°æ®å›ä¼ ç»™ AI è¿›è¡Œåˆ†æ...", 'info');
                    const finalRes = await fetch("https://api.deepseek.com/v1/chat/completions", {
                        method: "POST",
                        headers: { "Authorization": `Bearer ${DEEPSEEK_KEY}`, "Content-Type": "application/json" },
                        body: JSON.stringify({
                            model: "deepseek-chat",
                            messages: [
                                { role: "user", content: text },
                                msg,
                                { role: "tool", tool_call_id: toolCall.id, content: mcpData }
                            ]
                        })
                    });
                    const finalData = await finalRes.json();
                    appendChat('ai', finalData.choices[0].message.content);
                }, 2000);
            } else {
                appendChat('ai', msg.content);
            }
        } catch (err) {
            addLog("âŒ å‡ºé”™äº†: " + err.message, 'error');
        }
    }

    function appendChat(role, text) {
        const history = document.getElementById('chat-history');
        const div = document.createElement('div');
        div.className = `msg ${role}`;
        div.innerText = text;
        history.appendChild(div);
        history.scrollTop = history.scrollHeight;
    }
</script>
</body>
</html>
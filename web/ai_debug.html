<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MCP + DeepSeek æ™ºèƒ½è¿ç»´</title>
    <style>
        body { font-family: system-ui; background: #0d1117; color: #c9d1d9; padding: 20px; display: flex; gap: 20px; }
        .panel { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 15px; flex: 1; }
        #log { background: #000; color: #79c0ff; height: 300px; overflow-y: auto; font-size: 12px; padding: 10px; border-radius: 4px; }
        #chat-history { height: 300px; overflow-y: auto; border-bottom: 1px solid #333; margin-bottom: 10px; }
        .msg { margin: 8px 0; padding: 8px; border-radius: 4px; }
        .user { background: #1f6feb; text-align: right; }
        .ai { background: #238636; }
        input { width: 80%; padding: 8px; background: #010409; color: white; border: 1px solid #30363d; }
        button { padding: 8px 15px; cursor: pointer; background: #238636; color: white; border: none; border-radius: 4px; }
    </style>
</head>
<body>

<div class="panel">
    <h3>æ™ºèƒ½å¯¹è¯ (DeepSeek)</h3>
    <div id="chat-history"></div>
    <input type="text" id="userInput" placeholder="é—®é—®æœåŠ¡å™¨çŠ¶æ€...">
    <button onclick="askAI()">æé—®</button>
</div>

<div class="panel">
    <h3>MCP æ§åˆ¶å°</h3>
    <button onclick="initMCP()">1. è¿æ¥ MCP æœåŠ¡</button>
    <div id="status">çŠ¶æ€: æœªè¿æ¥</div>
    <div id="log"></div>
</div>

<script>
    const DEEPSEEK_KEY = "${DEEPSEEK_KEY}";
    let messageUrl = "";
    let mcpData = null; // å­˜å‚¨ MCP è¿”å›çš„æœ€æ–°æ•°æ®

    // --- 1. MCP é€»è¾‘ ---
    function addLog(msg, type = 'info') {
    const colors = {
        info: '#79c0ff',    // è“è‰² (ç³»ç»Ÿ)
        ai: '#aff5b4',      // ç»¿è‰² (AI)
        tool: '#d2a8ff',    // ç´«è‰² (å·¥å…·)
        error: '#ff7b72'    // çº¢è‰² (é”™è¯¯)
    };
    const div = document.createElement('div');
    div.style.color = colors[type] || colors.info;
    div.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
}
    const logEl = document.getElementById('log');

    async function initMCP() {
        const es = new EventSource('/sse');
        es.addEventListener("endpoint", async (e) => {
            messageUrl = e.data;
            await fetch(messageUrl, {
                method: "POST",
                body: JSON.stringify({
                    jsonrpc: "2.0", id: "i1", method: "initialize",
                    params: { protocolVersion: "2024-11-05", capabilities: {tools:{}}, clientInfo: {name: "web", version: "1.0"}}
                })
            });
            await fetch(messageUrl, { method: "POST", body: JSON.stringify({ jsonrpc: "2.0", method: "notifications/initialized" }) });
            document.getElementById('status').innerText = "çŠ¶æ€: å·²å°±ç»ª";
            addLog("âœ… MCP æœåŠ¡å™¨å·²å°±ç»ª");
        });

        es.onmessage = (e) => {
            const res = JSON.parse(e.data);
            if (res.result && res.result.content) {
                mcpData = res.result.content[0].text;
                addLog("ğŸ“¥ æ”¶åˆ°å·¥å…·ç»“æœ: " + mcpData);
            }
        };
    }

    // --- 2. DeepSeek é€»è¾‘ ---
    async function askAI() {
        const text = document.getElementById('userInput').value;
        if (!text) return;
        appendChat('user', text);

        // A. ç¬¬ä¸€æ¬¡è¯¢é—® DeepSeekï¼Œå¸¦ä¸Šå·¥å…·å®šä¹‰
        const response = await fetch("https://api.deepseek.com/v1/chat/completions", {
            method: "POST",
            headers: { "Authorization": `Bearer ${DEEPSEEK_KEY}`, "Content-Type": "application/json" },
            body: JSON.stringify({
                model: "deepseek-chat",
                messages: [{ role: "user", content: text }],
                tools: [{
                    type: "function",
                    function: {
                        name: "get_system_status",
                        description: "è·å–æœåŠ¡å™¨ CPU å’Œå†…å­˜å ç”¨"
                    }
                }]
            })
        });

        const data = await response.json();
        const msg = data.choices[0].message;

        // B. æ£€æŸ¥ AI æ˜¯å¦è¦æ±‚è°ƒç”¨å·¥å…·
        if (msg.tool_calls) {
            const toolCall = msg.tool_calls[0];
            addLog(`ğŸ¤– AI è¯·æ±‚è°ƒç”¨: ${toolCall.function.name}`);
            
            // æ‰§è¡Œ MCP å·¥å…·
            await fetch(messageUrl, {
                method: "POST",
                body: JSON.stringify({
                    jsonrpc: "2.0", id: "call_1",
                    method: "tools/call",
                    params: { name: "get_system_status", arguments: {} }
                })
            });

            // ç­‰å¾…ä¸€ç§’è®© SSE æ¥æ”¶æ•°æ®
            setTimeout(async () => {
                // C. å°†å·¥å…·ç»“æœå‘å›ç»™ AI
                const finalRes = await fetch("https://api.deepseek.com/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${DEEPSEEK_KEY}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            { role: "user", content: text },
                            msg,
                            { role: "tool", tool_call_id: toolCall.id, content: mcpData }
                        ]
                    })
                });
                const finalData = await finalRes.json();
                appendChat('ai', finalData.choices[0].message.content);
            }, 1500);
        } else {
            appendChat('ai', msg.content);
        }
    }

    function appendChat(role, text) {
        const div = document.createElement('div');
        div.className = `msg ${role}`;
        div.innerText = text;
        document.getElementById('chat-history').appendChild(div);
    }
</script>
</body>
</html>
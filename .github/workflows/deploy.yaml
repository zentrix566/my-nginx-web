name: Docker Build and Dynamic Deploy

on:
  push:
    branches: [ "main" ]  # åªæœ‰ main åˆ†æ”¯æäº¤æ—¶è§¦å‘
  schedule:
    - cron: '0 22 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š 6 ç‚¹è‡ªåŠ¨è¿è¡Œ (UTC 22:00)
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨åœ¨ GitHub é¡µé¢ç‚¹å‡»è¿è¡Œ

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # 2. è¿è¡Œæ³¨å…¥è„šæœ¬ï¼Œä¿®æ”¹ status.html çš„å†…å®¹
      - name: Inject Secrets into Config and HTML
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          DEEPSEEK_KEY: ${{ secrets.DEEPSEEK_KEY }}
        run: |
          if [ -z "$SERVER_IP" ] || [ -z "$DEEPSEEK_KEY" ]; then
            echo "âŒ Error: Secrets not set"
            exit 1
          fi

          # æ³¨å…¥ nginx.conf (sed æ›¿æ¢å ä½ç¬¦)
          # å‡è®¾ nginx.conf é‡Œç”¨çš„æ˜¯ ${SERVER_IP}ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­ç”¨ envsubst 
          # ä½†ä¸ºäº†ä¿é™©ï¼Œä¹Ÿå¯ä»¥åœ¨ nginx.conf é‡Œç”¨ __SERVER_IP__
          envsubst '${SERVER_IP}' < nginx.conf > nginx.conf.tmp && mv nginx.conf.tmp nginx.conf
          
          # ğŸ’¡ æ ¸å¿ƒæ”¹åŠ¨ï¼šä½¿ç”¨ sed æ›¿æ¢ html ä¸­çš„å ä½ç¬¦
          # -i è¡¨ç¤ºç›´æ¥ä¿®æ”¹æ–‡ä»¶ï¼Œs/æ—§/æ–°/g æ˜¯æ›¿æ¢æŒ‡ä»¤
          sed -i "s/__DS_KEY_PLACEHOLDER__/${DEEPSEEK_KEY}/g" web/ai_debug.html
          
          echo "âœ… Successfully injected Secrets using sed"

      # 3. ç™»å½•åˆ° GitHub é•œåƒä»“åº“ (GHCR)
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 4. æ„å»ºé•œåƒå¹¶æ¨é€åˆ°ä»“åº“
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      # 5. é€šè¿‡ SSH ç™»å½•æœåŠ¡å™¨å¹¶é€šçŸ¥ K3s é‡å¯ Pod
      - name: SSH Remote Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          # è¿™é‡ŒåŒæ ·ä½¿ç”¨ Secret
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 57892
          script: |
            # å¼ºåˆ¶ K3s é‡æ–°æ‹‰å–æœ€æ–°çš„é•œåƒå¹¶é‡å¯ Pod
            kubectl rollout restart deployment my-nginx